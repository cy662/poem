# 用户认证功能部署指南

## 概述

本文档指导您如何部署用户认证功能和RLS策略，使您的诗词应用具备完整的权限控制。

## 部署步骤

### 1. 部署RLS策略到Supabase

在Supabase SQL编辑器中执行以下脚本：

1. **执行基础RLS策略**：
   ```sql
   -- 复制 scripts/simple-rls-setup.sql 的内容到Supabase SQL编辑器并执行
   ```

2. **验证RLS策略**：
   - 检查所有表是否已启用RLS
   - 验证策略是否正确创建

### 2. 配置Supabase Auth

1. **启用邮箱认证**：
   - 在Supabase Dashboard中进入 Authentication → Settings
   - 启用 "Email" 提供者
   - 配置重定向URL：`http://localhost:5173` (开发环境)

2. **配置网站URL**：
   - 在 Authentication → URL Configuration
   - 设置 Site URL 为您的应用地址

### 3. 设置管理员用户

1. **通过Supabase Dashboard**：
   - 进入 Authentication → Users
   - 为用户设置metadata：`{"role": "admin"}`

2. **通过SQL命令**：
   ```sql
   UPDATE auth.users 
   SET raw_user_meta_data = '{"role": "admin"}' 
   WHERE email = 'admin@example.com';
   ```

### 4. 配置环境变量

确保您的 `.env` 文件包含正确的Supabase配置：

```env
VITE_SUPABASE_URL=您的Supabase项目URL
VITE_SUPABASE_ANON_KEY=您的Supabase匿名密钥
```

### 5. 测试认证功能

1. **注册新用户**：
   - 访问 `/register` 页面
   - 填写注册信息
   - 检查邮箱确认邮件

2. **登录测试**：
   - 访问 `/login` 页面
   - 使用注册的账号登录
   - 验证用户状态显示

3. **权限测试**：
   - 登录后尝试访问 `/add-poem`
   - 验证是否可以添加诗词
   - 测试管理员权限

## 功能特性

### 🔐 认证功能
- **用户注册**：邮箱+密码注册，支持显示名称
- **用户登录**：安全的登录验证
- **会话管理**：自动保持登录状态
- **安全退出**：清除所有认证信息

### 🛡️ 权限控制
- **页面级权限**：路由守卫保护敏感页面
- **角色管理**：用户/管理员两级权限
- **数据级权限**：RLS策略控制数据访问

### 📱 用户体验
- **响应式设计**：适配桌面和移动端
- **状态管理**：全局用户状态管理
- **错误处理**：友好的错误提示

## 故障排除

### 常见问题

1. **RLS策略不生效**：
   - 检查表是否启用RLS
   - 验证策略条件是否正确
   - 确认用户认证状态

2. **认证失败**：
   - 检查环境变量配置
   - 验证Supabase项目设置
   - 查看浏览器控制台错误

3. **权限错误**：
   - 确认用户角色设置
   - 检查路由守卫逻辑
   - 验证Pinia store状态

### 调试工具

1. **Supabase日志**：
   - 查看Authentication日志
   - 检查Database查询日志

2. **浏览器开发者工具**：
   - 查看网络请求
   - 检查LocalStorage状态
   - 查看控制台错误

## 安全建议

1. **生产环境配置**：
   - 使用HTTPS
   - 配置正确的重定向URL
   - 设置强密码策略

2. **数据保护**：
   - 定期备份数据库
   - 监控异常访问
   - 更新依赖包

## 后续扩展

1. **社交登录**：集成Google、GitHub等第三方登录
2. **多因素认证**：增加短信或应用验证
3. **权限细化**：更细粒度的角色权限控制

---

**完成以上步骤后，您的诗词应用将具备完整的用户认证和权限控制功能！**